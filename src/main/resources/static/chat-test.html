<!DOCTYPE html>
<html>
<head>
  <title>Private Chat Test</title>
  <!-- 1. SockJS 먼저 로드 (로컬 파일) -->
  <script src="/js/sockjs.min.js"></script>
  <!-- 2. STOMP 클라이언트 (umd 버전) 로드 -->
  <script src="/js/stomp.umd.js"></script>
</head>
<body>
<div>
  <input type="text" id="chatRoomId" placeholder="Room ID (예: 2)">
  <input type="text" id="senderId" placeholder="Sender ID (예: 1)">
  <input type="text" id="receiverId" placeholder="Receiver ID (예: 2)">
  <input type="text" id="content" placeholder="Message">
  <button onclick="sendPrivateMessage()">Send Private</button>
</div>
<div id="chatLogs"></div>

<script>
  var stompClient = null;

  function connect() {
    var socket = new SockJS('/ws-stomp');
    // stomp.umd.js는 전역으로 StompJs를 정의하므로, StompJs.Stomp를 사용합니다.
    stompClient = StompJs.Stomp.over(socket);

    stompClient.connect({}, function(frame) {
      console.log('Connected: ' + frame);
      // /user/queue/private 경로를 구독합니다.
      stompClient.subscribe('/user/queue/private', function(message) {
        var msgObj = JSON.parse(message.body);
        var logDiv = document.getElementById("chatLogs");
        logDiv.innerHTML += "<p><b>From: " + msgObj.senderUsername + "</b> (to: " + msgObj.receiverUsername + ") - " + msgObj.content + "</p>";
      });
    });
  }

  function sendPrivateMessage() {
    var chatRoomId = document.getElementById('chatRoomId').value;
    var senderId = document.getElementById('senderId').value;
    var receiverId = document.getElementById('receiverId').value;
    var content = document.getElementById('content').value;

    // 내가 보낸 메시지를 바로 화면에 표시
    var logDiv = document.getElementById("chatLogs");
    logDiv.innerHTML += "<p><b>Sent: </b>" + content + "</p>";

    // 숫자로 변환해서 전송 (채팅방ID, senderId, receiverId는 숫자여야 함)
    var payload = {
      chatRoomId: parseInt(chatRoomId),
      senderId: parseInt(senderId),
      receiverId: parseInt(receiverId),
      content: content
    };

    stompClient.send("/app/chat/private", {}, JSON.stringify(payload));
  }

  // 페이지 로드 시 연결
  window.onload = connect;
</script>
</body>
</html>
